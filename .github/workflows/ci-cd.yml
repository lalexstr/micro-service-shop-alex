name: CI/CD Pipeline

on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master
      - dev

env:
  DOCKER_BUILDKIT: 1

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Run tests for all Go services
        run: |
          for service in auth-service product-service user-service project-service portfolio-service contact-service; do
            echo "Running tests for $service..."
            if [ -f "$service/go.mod" ]; then
              cd "$service"
              go mod download
              go test -v ./... || echo "No tests found or failed in $service"
              cd ..
            else
              echo "No go.mod in $service, skipping"
            fi
          done
        continue-on-error: true

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          timeout: 120s
          command_timeout: 180m
          script_stop: true
          debug: true
          envs: "SSH_CLIENT_ALIVE_INTERVAL=60 SSH_CLIENT_ALIVE_COUNT_MAX=120 GOMAXPROCS=2"
          script: |
        set -x
        DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
        mkdir -p "$DEPLOY_PATH"
        cd "$DEPLOY_PATH" || exit 1

        if [ ! -d ".git" ]; then
          git init
          git remote add origin https://github.com/${{ github.repository }}.git
          git fetch origin
          git checkout -b master origin/master || git checkout master
        else
          git fetch origin
          git reset --hard origin/master
        fi

        docker compose down || true
        export DOCKER_BUILDKIT=1
        export COMPOSE_DOCKER_CLI_BUILD=1

        CURRENT_COMMIT=$(git rev-parse HEAD)
        CHANGED_SERVICES=""

        if [ ! -f .last_deploy_commit ]; then
          echo "First deployment — building all services"
          CHANGED_SERVICES="auth-service user-service product-service project-service portfolio-service contact-service"
        else
          LAST_COMMIT=$(cat .last_deploy_commit 2>/dev/null || echo "")
          echo "Last commit: $LAST_COMMIT"
          echo "Current commit: $CURRENT_COMMIT"

          if [ "$LAST_COMMIT" != "$CURRENT_COMMIT" ]; then
            for service in auth-service user-service product-service project-service portfolio-service contact-service; do
              # git diff --quiet возвращает 0 если нет изменений, 1 если есть изменения
              # Сохраняем код выхода в переменную, чтобы не вызывать ошибку SSH action
              git diff --quiet "$LAST_COMMIT" HEAD -- "$service/" 2>/dev/null
              DIFF_EXIT_CODE=$?
              if [ $DIFF_EXIT_CODE -eq 0 ]; then
                echo "$service: no changes"
              else
                echo "$service: changed"
                CHANGED_SERVICES="$CHANGED_SERVICES $service"
              fi
            done
          else
            echo "No changes since last deploy"
          fi
        fi

        if [ -z "$CHANGED_SERVICES" ]; then
          echo "No services changed — skipping build"
        else
          echo "Building: $CHANGED_SERVICES"
          if [ "$CHANGED_SERVICES" = "auth-service user-service product-service project-service portfolio-service contact-service" ]; then
            docker compose build --parallel || {
              for s in $CHANGED_SERVICES; do docker compose build "$s" || exit 1; done
            }
          else
            for s in $CHANGED_SERVICES; do docker compose build "$s" || exit 1; done
          fi
          echo "$CURRENT_COMMIT" > .last_deploy_commit
        fi

        docker image prune -f || true
        docker compose up -d
        sleep 10
        docker compose ps
